# Контур Отель — Счёт и подтверждение

Chrome-расширение для hotel.kontur.ru, которое добавляет кнопки формирования и отправки PDF-документов прямо из окна бронирования.

## Функционал

### Счёт на предоплату
- Автоматическое обнаружение открытого окна бронирования на hotel.kontur.ru
- Парсинг данных: **Заказчик** (ФИО или реквизиты организации), email, даты, номер комнаты, стоимость, номер бронирования, количество гостей
- Расчёт предоплаты: сумма первых 3 суток (по данным из тултипа «Стоимость проживания»)
- Фоллбэк: (общая сумма / кол. ночей) × 3 (если посуточные цены недоступны)
- Описание предоплаты в счёте: «первые 3 суток» (при бронировании 3+ ночей)
- **Тултип «Стоимость проживания»**: при наведении курсора на иконку ⓘ в тултипе отображается строка «Предоплата (первые 3 сут.): X ₽»
- **Кеширование посуточных цен**: расширение запоминает цены из тултипа для использования в счёте
- **Стрелка-подсказка**: при попытке скачать/отправить счёт без загруженных цен, появляется анимированная стрелка, указывающая на иконку ⓘ
- Скидка за длительное проживание:
  - 4–5 ночей — скидка **5%** на полную оплату
  - 6+ ночей — скидка **8%** на полную оплату
- Генерация PDF-счёта с реквизитами отеля и банковскими данными
- **Количество гостей** отображается в информации о бронировании
- **Выделенный блок «Назначение платежа»** с ФИО гостя (синяя рамка, верхний и нижний паддинг)
- **Печать и подпись директора** — встроенные изображения на линии подписи
- **QR-коды для оплаты** (ГОСТ Р 56042-2014):
  - QR предоплаты (сумма первых 3 суток) — всегда отображается
  - QR полной оплаты (с учётом скидки) — отображается только если отличается от предоплаты (4+ ночи)
- **Адаптивный размер QR-кодов**: автоматически подстраивается под доступное место (26-38мм) для размещения на странице A4
- **Перенос длинных реквизитов**: если реквизиты заказчика не помещаются в одну строку, автоматически переносятся
- Автоматическая отправка PDF на email гостя через Яндекс Почту (SMTP)
- Сохранение отправленных писем в папку «Отправленные» Яндекс Почты (IMAP)
- Скачивание PDF-копии на компьютер

### Подтверждение бронирования (Ваучер)
- Генерация PDF **«ПОДТВЕРЖДЕНИЕ БРОНИРОВАНИЯ (ВАУЧЕР)»** на **1 лист А4** (компактный макет) с полной информацией:
  - **Данные заказчика** (Заказчик: ФИО или реквизиты организации, email, телефон)
  - Детали бронирования (категория номера, даты, время заезда/выезда, количество ночей и гостей)
  - **Финансовая информация**: общая стоимость, внесённая оплата, сумма к оплате в отеле
  - **Расширенные условия проживания**: правила заезда/выезда, необходимые документы, дети до 4 лет, включённые услуги (питание, бассейн, детские центры, развлечения, парковка, спа)
  - **Условия отмены бронирования**: полный возврат при отмене ≥15 дней; штраф 1 сутки при отмене <15 дней
  - **Печать и подпись директора** — встроенные изображения печати и подписи
- **Перенос длинных реквизитов заказчика**: если реквизиты не помещаются в одну строку, автоматически переносятся
- Скачивание PDF подтверждения на компьютер
- Автоматическая отправка подтверждения на email гостя
- **Замена встроенной функции**: скрывает стандартный блок «Подтверждение не отправлено» и удаляет пункт «Отправить подтверждение» из меню «Другие действия»

### Парсер данных (DOM)
- **Приоритетный источник**: секция «Информация» — извлекает реквизиты заказчика из элемента `.rkW8Ki`
- **Фоллбэк**: секция «Гости» — используется если организация не указана в «Информация»
- **Распознавание иконок**: определяет иконку человека по SVG-path (`M10 2a4.499`, `M10 2.002a4.532`)
- **Поддержка организаций**: корректно извлекает полные реквизиты (ООО, ИНН, КПП, ОГРН, р/с, БИК)
- **Исключение лишних данных**: не захватывает телефон, email, номер брони, возраст детей
- **Не зависит от хешированных CSS-классов**: использует стабильные селекторы и текстовые маркеры

## Архитектура (многопользовательский режим)

```
Сотрудник 1 (Chrome) ──┐
Сотрудник 2 (Chrome) ──┼──► Backend на Vercel ──► Яндекс SMTP ──► Email гостя
Сотрудник N (Chrome) ──┘    (один на всех)
```

- **Backend** — разворачивается один раз администратором. SMTP-пароль хранится только на сервере.
- **Расширение** — устанавливается на каждый рабочий ПК. Сотрудники вводят только URL сервера и API-ключ.
- **Безопасность** — сотрудники не видят пароль Яндекс Почты. API-ключ защищает от несанкционированного доступа.

## Структура проекта

```
KonturExpansionChrome/
├── manifest.json                    — Манифест расширения (Manifest V3)
├── src/
│   ├── content/
│   │   ├── content.js               — MutationObserver, кнопки, кеш посуточных цен, тултип предоплаты, стрелка-подсказка
│   │   └── content.css              — Стили кнопок, тостов, тултип-предоплаты, стрелки-подсказки
│   ├── background/
│   │   └── service-worker.js        — Фоновый скрипт: обработка сообщений, вызов API
│   ├── popup/
│   │   ├── popup.html               — Интерфейс настроек (URL сервера + API-ключ)
│   │   ├── popup.js                 — Логика настроек
│   │   └── popup.css                — Стили попапа
│   ├── utils/
│   │   ├── data-parser.js           — Парсер DOM + посуточные цены из тултипа/модального окна + parseBookingModalData
│   │   ├── invoice-generator.js     — Генерация PDF-счёта (шапка как в ваучере, QR-коды, печать 56мм)
│   │   ├── confirmation-generator.js — Генерация PDF ваучера (компактный макет на 1 лист А4, печать 56мм)
│   │   └── email-sender.js          — Клиент для отправки email через service worker
│   ├── config/
│   │   └── hotel-details.js         — Реквизиты отеля (ИНН, р/с, банк и т.д.)
│   ├── fonts/
│   │   └── roboto-regular.js        — Шрифт Roboto (base64) для кириллицы в PDF
│   └── images/
│       └── stamp-signature.js       — Печать и подпись директора (base64 PNG)
├── libs/
│   ├── jspdf.umd.min.js            — Библиотека jsPDF v2.5.2
│   └── qrcode.js                   — Генератор QR-кодов (qrcode-generator v1.4.4)
├── icons/                           — Иконки расширения (16, 48, 128 px)
├── backend/                         — Серверная часть для отправки email
│   ├── api/
│   │   └── send-invoice.js          — Vercel serverless function (nodemailer SMTP + IMAP «Отправленные»)
│   ├── package.json
│   └── vercel.json                  — Конфигурация деплоя Vercel
└── README.md
```

## Установка (делает администратор — один раз)

### Шаг 1. Заполните реквизиты отеля

Отредактируйте файл `src/config/hotel-details.js` — замените все placeholder-значения реальными данными вашего отеля.

### Шаг 2. Придумайте API-ключ

Придумайте длинный секретный ключ (например: `albatros-kontur-admin`). Этот ключ будет использоваться для авторизации расширения на сервере.

### Шаг 3. Создайте пароль приложения Яндекс

Яндекс не позволяет использовать основной пароль для SMTP. Нужен **пароль приложения**:

1. Перейдите в [Яндекс ID → Пароли приложений](https://id.yandex.ru/security/app-passwords)
2. Нажмите «Создать пароль приложения»
3. Выберите тип «Почта»
4. Скопируйте сгенерированный пароль — он понадобится на шаге 4

### Шаг 4. Разверните backend на Vercel

```bash
cd backend
npm install
npx vercel
```

При первом деплое Vercel попросит авторизоваться. После этого задайте переменные окружения:

```bash
npx vercel env add SMTP_EMAIL      # Введите: hotel@yandex.ru (ваш email)
npx vercel env add SMTP_PASSWORD   # Введите: пароль приложения из шага 3
npx vercel env add API_KEY         # Введите: API-ключ из шага 2
```

Затем задеплойте в продакшен:

```bash
npx vercel --prod
```

Вы получите URL вида `https://your-app.vercel.app` — запишите его.

### Шаг 5. Парсер DOM (уже настроен)

Парсер `src/utils/data-parser.js` настроен на реальную структуру Контур Отеля (февраль 2026). Он НЕ зависит от хешированных CSS-классов — вместо этого использует:
- URL-паттерн `/bookings/.../id/...`
- Стабильный id `#MainPageTopBar`
- Текстовые маркеры разделов ("Оплата", "Гости", "Информация")
- Regex-паттерны для извлечения данных (OTL-..., email, цена ₽)
- **Приоритет**: секция «Информация» с иконкой человека — извлекает ТОЛЬКО текст из `.rkW8Ki` (реквизиты заказчика)
- **Фоллбэк**: секция «Гости» — используется если организация не указана в «Информация»
- **Распознавание иконок**: определяет иконку человека по SVG-path (`M10 2a4.499`, `M10 2.002a4.532`, `4.5 4.5 0 1 0`)
- **Поддержка организаций**: корректно извлекает полные реквизиты (ООО, ИНН, КПП, ОГРН, р/с, БИК)
- **Исключение лишних данных**: не захватывает телефон, email, номер брони, возраст детей («19 лет» и т.п.)
- Телефон ищется **только в секции «Информация»**, чтобы не спутать с цифрами номера бронирования (OTL-0000000024)

## Установка на рабочие места сотрудников

На каждом компьютере сотрудника:

1. Откройте `chrome://extensions/`
2. Включите **Режим разработчика** (переключатель вверху справа)
3. Нажмите **Загрузить распакованное расширение**
4. Выберите папку `KonturExpansionChrome/`
5. Кликните на иконку расширения в панели Chrome
6. Заполните:
   - **URL сервера** — URL из шага 4 установки администратором
   - **API-ключ** — ключ из шага 2
7. Нажмите **Сохранить**

Готово! Теперь при открытии бронирования на hotel.kontur.ru появятся кнопки управления документами.

## Использование

1. Откройте hotel.kontur.ru
2. Откройте любое бронирование
3. **Наведите курсор на стоимость проживания** — появится тултип с ценами по дням и строкой «Предоплата»
4. В шапке бронирования появятся 4 кнопки:
   - **Скачать счёт** — скачивает PDF-счёт на предоплату (требует предварительно открыть тултип с ценами)
   - **Отправить на email** — отправляет PDF-счёт на email гостя (требует предварительно открыть тултип с ценами)
   - **Скачать подтверждение** — скачивает PDF подтверждения бронирования
   - **Отправить подтверждение** — отправляет PDF подтверждения на email гостя
5. Встроенный блок «Подтверждение не отправлено» автоматически скрывается
6. Пункт «Отправить подтверждение» убирается из меню «Другие действия»

## Логика скидок и QR-кодов

| Количество ночей | Скидка на полную оплату | QR-коды в счёте |
|------------------|------------------------|-----------------|
| 1–3 ночи         | 0% (без скидки)        | 1 QR (предоплата = полная сумма) |
| 4–5 ночей        | 5%                     | 2 QR (предоплата + полная оплата со скидкой) |
| 6+ ночей         | 8%                     | 2 QR (предоплата + полная оплата со скидкой) |

**Почему так:** При бронировании на 3 ночи или меньше сумма предоплаты равна полной стоимости, поэтому второй QR-код не отображается (они были бы одинаковыми). При 4+ ночах появляются два QR-кода: первый для предоплаты (первые 3 суток), второй — для полной оплаты со скидкой.

Скидка применяется только к QR-коду полной оплаты. Предоплата (первые 3 суток) всегда без скидки.

## Адаптация макета

### Перенос длинных реквизитов
Если реквизиты заказчика (ООО с ИНН, КПП, ОГРН, р/с, БИК) не помещаются в одну строку:
- **Счёт**: используется `splitTextToSize()` для авто-переноса текста
- **Ваучер**: аналогично, реквизиты занимают несколько строк
- Максимальная ширина значения: `contentWidth - 4мм`

### Адаптивный размер QR-кодов
QR-коды автоматически подстраиваются под доступное место на странице:
- **Диапазон размеров**: 26-38мм (минимум 26мм, максимум 38мм)
- **Расчёт**: `qrSize = Math.min(38, Math.max(26, availableForQR - 12))`
- **Фиксированный резерв после QR**: 52мм (подписи, назначение платежа, примечание, директор)
- **Низ страницы**: 292мм (A4 297мм - 5мм отступ)
- **Зазор между QR**: 12мм (для двух QR-кодов)

Это гарантирует, что счёт полностью поместится на странице A4 даже при длинных реквизитах заказчика.

## Технологии

- **Chrome Extension Manifest V3** — современный стандарт расширений
- **jsPDF 2.5.2** — генерация PDF на клиенте
- **qrcode-generator 1.4.4** — генерация QR-кодов (ГОСТ Р 56042-2014)
- **Nodemailer** — отправка email через SMTP
- **ImapFlow** — сохранение отправленных писем в «Отправленные» через IMAP
- **Busboy** — парсинг multipart/form-data на сервере
- **Vercel Serverless Functions** — бесплатный хостинг backend
- **Яндекс SMTP** (smtp.yandex.ru:465) — исходящая почта
- **Яндекс IMAP** (imap.yandex.ru:993) — сохранение в «Отправленные»

## Оптимизация передачи данных

PDF-файлы содержат встроенные ресурсы (шрифт Roboto, печать, подпись, QR-коды), из-за чего могут быть достаточно большими (~800 КБ+).

Для отправки PDF на backend используется **multipart/form-data** вместо JSON с base64:
- PDF передаётся как бинарный файл (экономия ~33% по сравнению с base64 в JSON)
- Метаданные (email, тема, текст) передаются как form fields
- Backend поддерживает обе формата (multipart и JSON) для обратной совместимости
- Стандартный bodyParser Vercel отключён (`bodyParser: false`) для поддержки multipart
